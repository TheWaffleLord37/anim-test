name: Cycle main.png through frames

on:
  schedule:
    - cron: '0 8,20 * * *'  # Runs at 1:00 AM and 1:00 PM PDT (08:00 and 20:00 UTC)
  workflow_dispatch:         # Allows manual trigger from Actions tab

jobs:
  update-frame:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      # Read current index from the pointer file
      - name: Read current index
        id: idx
        run: |
          INDEX=$(cat frame_index.txt)
          echo "index=$INDEX" >> "$GITHUB_OUTPUT"

      # Copy the corresponding frame over main.png
      - name: Replace main.png with selected frame
        run: |
          cp "frames/${{ steps.idx.outputs.index }}.png" main.png

      # Calculate and write the next index (wrap 4 → 1)
      - name: Bump pointer
        run: |
          CUR=${{ steps.idx.outputs.index }}
          NEXT=$(( CUR == 4 ? 1 : CUR + 1 ))
          echo $NEXT > frame_index.txt

      # Commit only if something actually changed
      - name: Commit & push if updated
        run: |
          git config --global user.name  "github-actions"
          git config --global user.email "github-actions@github.com"
          git add main.png frame_index.txt
          git diff --cached --quiet && echo "No changes" || \
            (git commit -m "Auto-update to frame $CUR" && git push)

      # Discord notification (runs on successful workflow completion)
      - name: Notify Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"## Flutterdance template updated to frame **${{ steps.idx.outputs.index }}**\\nRefresh your template or reopen it with the link below!\\n# [Template](<https://pxls.space/#x=1450&y=1368&scale=8&template=https%3A%2F%2Fraw.githubusercontent.com%2FTheWaffleLord37%2FManePxls-Templates%2Frefs%2Fheads%2Fmain%2FCanvas%2090%2FFlutterdance.png&ox=1396&oy=1321&tw=108&title=Flutterdance&convert=nearestCustom>)\\n-# dinkdonk new frame [⠀](https://cdn.discordapp.com/emojis/1375011774067376128.webp?size=128&animated=true)\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
